"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const fs_1 = require("fs");
const postgresql_client_1 = require("postgresql-client");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const logger_1 = require("@aws-lambda-powertools/logger");
const logging_util_1 = require("./logging-util");
const PointCollectorLogFormatter_1 = require("./PointCollectorLogFormatter");
const logger = new logger_1.Logger({ serviceName: (0, logging_util_1.serviceName)("db-setup"), logFormatter: new PointCollectorLogFormatter_1.PointCollectorLogFormatter() });
/*
    This handler will do the basic database setup.

    It creates the schema and sets up roles and users required for the service.

    This handler is idempotent, i.e. if it has run before, it will not do any changes.
*/
const handler = async (_, context) => {
    logger.addContext(context);
    if (process.env.REGION === undefined ||
        process.env.DB_SECRET_ARN === undefined ||
        process.env.DB_SCHEMA_NAME === undefined ||
        process.env.DB_USER_SECRET_ARN == undefined) {
        throw new Error("Missing environment variable (either REGION, DB_SECRET_ARN or DB_SCHEMA_NAME or DB_USER_SECRET_ARN");
    }
    try {
        const REGION = process.env.REGION;
        const SCHEMA = process.env.DB_SCHEMA_NAME;
        const secretsManager = new client_secrets_manager_1.SecretsManager({ region: REGION });
        const clusterSecret = await resolveSecret(secretsManager, process.env.DB_SECRET_ARN);
        const dbUserSecret = await resolveSecret(secretsManager, process.env.DB_USER_SECRET_ARN);
        logger.info("Opening connection...");
        const connection = getConnection(clusterSecret);
        await connection.connect();
        // According to recommendations at https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Security.html#Appendix.PostgreSQL.CommonDBATasks.Roles
        // Remove permissions on public schema
        const removePermissionsOnPublicSchemaResult = await connection.execute("REVOKE CREATE ON SCHEMA public FROM public");
        logger.info(`Revoke from public schema statement took ${removePermissionsOnPublicSchemaResult.totalTime}`);
        // Revoke permissions on public schema on our database
        const revokeOnDatabaseResult = await connection.execute(`REVOKE ALL ON DATABASE ${clusterSecret.dbname} FROM public`);
        logger.info(`Revoke from database took ${revokeOnDatabaseResult.totalTime}`);
        // Create our schema
        const schemaCreationResult = await connection.execute(`CREATE SCHEMA IF NOT EXISTS ${SCHEMA}`);
        logger.info(`Create schema statement took ${schemaCreationResult.totalTime}`);
        // Create user
        // Backend user (can do anything in the schema)
        const DB_USER = dbUserSecret.username;
        const stmt = `DO\
            $do$\
            BEGIN\
                IF EXISTS (\
                    SELECT FROM pg_catalog.pg_roles\
                    WHERE  rolname = '${DB_USER}') THEN\
                    RAISE NOTICE 'Role "${DB_USER}" already exists. Skipping creation.';\
                ELSE\
                    CREATE ROLE ${DB_USER} LOGIN PASSWORD '${dbUserSecret.password}';\
                END IF;\
                GRANT CONNECT ON DATABASE ${clusterSecret.dbname} TO ${DB_USER};\
                GRANT USAGE ON SCHEMA ${SCHEMA} TO ${DB_USER};\
                GRANT ALL PRIVILEGES ON SCHEMA ${SCHEMA} TO ${DB_USER};\
            END\
            $do$;`;
        const migrationUserCreationResult = await connection.execute(stmt);
        logger.info(`Create ${DB_USER} user statement took ${migrationUserCreationResult.totalTime}`);
        await connection.close();
    }
    catch (error) {
        logger.error("error", (0, logging_util_1.logData)(error));
        throw error;
    }
    return {
        PhysicalResourceId: "DBSetup",
        Data: {
            Response: "Successfully setup DB"
        }
    };
};
exports.handler = handler;
async function resolveSecret(secretsManager, secretId) {
    const secretValue = await secretsManager.getSecretValue({
        SecretId: secretId
    });
    if (secretValue.SecretString === undefined) {
        throw new Error(`No secret string for ${secretId}`);
    }
    const secret = JSON.parse(secretValue.SecretString);
    return secret;
}
function getConnection(secret) {
    return new postgresql_client_1.Connection({
        host: secret.host,
        port: secret.port,
        user: secret.username,
        password: secret.password,
        database: secret.dbname,
        ssl: {
            rejectUnauthorized: false,
            ca: (0, fs_1.readFileSync)("./eu-west-1-bundle.cert").toString() // cert from https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/UsingWithRDS.SSL.html
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkJBQWlDO0FBRWpDLHlEQUE4QztBQUM5Qyw0RUFBZ0U7QUFDaEUsMERBQXNEO0FBRXRELGlEQUFxRDtBQUNyRCw2RUFBeUU7QUFhekUsTUFBTSxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBQSwwQkFBVyxFQUFDLFVBQVUsQ0FBQyxFQUFFLFlBQVksRUFBRSxJQUFJLHVEQUEwQixFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBRW5IOzs7Ozs7RUFNRTtBQUNLLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxDQUF5QixFQUFFLE9BQWdCLEVBQXNDLEVBQUU7SUFDN0csTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUUxQixJQUNJLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLFNBQVM7UUFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEtBQUssU0FBUztRQUN2QyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsS0FBSyxTQUFTO1FBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksU0FBUyxFQUM3QyxDQUFDO1FBQ0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxvR0FBb0csQ0FBQyxDQUFBO0lBQ3pILENBQUM7SUFFRCxJQUFJLENBQUM7UUFDRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQTtRQUNqQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQTtRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLHVDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQTtRQUU3RCxNQUFNLGFBQWEsR0FBd0IsTUFBTSxhQUFhLENBQUMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxH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SSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1FBQ2pCLElBQUksRUFBRSxNQUFNLENBQUMsUUFBUTtRQUNyQixRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVE7UUFDekIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxNQUFNO1FBQ3ZCLEdBQUcsRUFBRTtZQUNELGtCQUFrQixFQUFFLEtBQUs7WUFDekIsRUFBRSxFQUFFLElBQUEsaUJBQVksRUFBQyx5QkFBeUIsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLCtGQUErRjtTQUN6SjtLQUNKLENBQUMsQ0FBQTtBQUNOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tIFwiZnNcIlxuXG5pbXBvcnQgeyBDb25uZWN0aW9uIH0gZnJvbSBcInBvc3RncmVzcWwtY2xpZW50XCJcbmltcG9ydCB7IFNlY3JldHNNYW5hZ2VyIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXJcIlxuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSBcIkBhd3MtbGFtYmRhLXBvd2VydG9vbHMvbG9nZ2VyXCJcblxuaW1wb3J0IHsgbG9nRGF0YSwgc2VydmljZU5hbWUgfSBmcm9tIFwiLi9sb2dnaW5nLXV0aWxcIlxuaW1wb3J0IHsgUG9pbnRDb2xsZWN0b3JMb2dGb3JtYXR0ZXIgfSBmcm9tIFwiLi9Qb2ludENvbGxlY3RvckxvZ0Zvcm1hdHRlclwiXG5pbXBvcnQge0Nka0N1c3RvbVJlc291cmNlRXZlbnQsIENka0N1c3RvbVJlc291cmNlUmVzcG9uc2UsIENvbnRleHR9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5pbnRlcmZhY2UgRGF0YWJhc2VTZWNyZXRWYWx1ZSB7XG4gICAgdXNlcm5hbWU6IHN0cmluZ1xuICAgIHBhc3N3b3JkOiBzdHJpbmdcbiAgICBob3N0OiBzdHJpbmdcbiAgICBwb3J0OiBudW1iZXJcbiAgICBlbmdpbmU6IHN0cmluZ1xuICAgIGRibmFtZTogc3RyaW5nXG4gICAgbWFzdGVyYXJuOiBzdHJpbmdcbn1cblxuY29uc3QgbG9nZ2VyID0gbmV3IExvZ2dlcih7IHNlcnZpY2VOYW1lOiBzZXJ2aWNlTmFtZShcImRiLXNldHVwXCIpLCBsb2dGb3JtYXR0ZXI6IG5ldyBQb2ludENvbGxlY3RvckxvZ0Zvcm1hdHRlcigpIH0pXG5cbi8qXG4gICAgVGhpcyBoYW5kbGVyIHdpbGwgZG8gdGhlIGJhc2ljIGRhdGFiYXNlIHNldHVwLlxuXG4gICAgSXQgY3JlYXRlcyB0aGUgc2NoZW1hIGFuZCBzZXRzIHVwIHJvbGVzIGFuZCB1c2VycyByZXF1aXJlZCBmb3IgdGhlIHNlcnZpY2UuXG5cbiAgICBUaGlzIGhhbmRsZXIgaXMgaWRlbXBvdGVudCwgaS5lLiBpZiBpdCBoYXMgcnVuIGJlZm9yZSwgaXQgd2lsbCBub3QgZG8gYW55IGNoYW5nZXMuXG4qL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXzogQ2RrQ3VzdG9tUmVzb3VyY2VFdmVudCwgY29udGV4dDogQ29udGV4dCk6IFByb21pc2U8Q2RrQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4gPT4ge1xuICAgIGxvZ2dlci5hZGRDb250ZXh0KGNvbnRleHQpXG5cbiAgICBpZiAoXG4gICAgICAgIHByb2Nlc3MuZW52LlJFR0lPTiA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAgIHByb2Nlc3MuZW52LkRCX1NFQ1JFVF9BUk4gPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICBwcm9jZXNzLmVudi5EQl9TQ0hFTUFfTkFNRSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAgIHByb2Nlc3MuZW52LkRCX1VTRVJfU0VDUkVUX0FSTiA9PSB1bmRlZmluZWRcbiAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZSAoZWl0aGVyIFJFR0lPTiwgREJfU0VDUkVUX0FSTiBvciBEQl9TQ0hFTUFfTkFNRSBvciBEQl9VU0VSX1NFQ1JFVF9BUk5cIilcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgICBjb25zdCBSRUdJT04gPSBwcm9jZXNzLmVudi5SRUdJT05cbiAgICAgICAgY29uc3QgU0NIRU1BID0gcHJvY2Vzcy5lbnYuREJfU0NIRU1BX05BTUVcbiAgICAgICAgY29uc3Qgc2VjcmV0c01hbmFnZXIgPSBuZXcgU2VjcmV0c01hbmFnZXIoeyByZWdpb246IFJFR0lPTiB9KVxuXG4gICAgICAgIGNvbnN0IGNsdXN0ZXJTZWNyZXQ6IERhdGFiYXNlU2VjcmV0VmFsdWUgPSBhd2FpdCByZXNvbHZlU2VjcmV0KHNlY3JldHNNYW5hZ2VyLCBwcm9jZXNzLmVudi5EQl9TRUNSRVRfQVJOKVxuICAgICAgICBjb25zdCBkYlVzZXJTZWNyZXQ6IERhdGFiYXNlU2VjcmV0VmFsdWUgPSBhd2FpdCByZXNvbHZlU2VjcmV0KHNlY3JldHNNYW5hZ2VyLCBwcm9jZXNzLmVudi5EQl9VU0VSX1NFQ1JFVF9BUk4pXG5cbiAgICAgICAgbG9nZ2VyLmluZm8oXCJPcGVuaW5nIGNvbm5lY3Rpb24uLi5cIilcbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGdldENvbm5lY3Rpb24oY2x1c3RlclNlY3JldClcbiAgICAgICAgYXdhaXQgY29ubmVjdGlvbi5jb25uZWN0KClcblxuICAgICAgICAvLyBBY2NvcmRpbmcgdG8gcmVjb21tZW5kYXRpb25zIGF0IGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BbWF6b25SRFMvbGF0ZXN0L0F1cm9yYVVzZXJHdWlkZS9BdXJvcmFQb3N0Z3JlU1FMLlNlY3VyaXR5Lmh0bWwjQXBwZW5kaXguUG9zdGdyZVNRTC5Db21tb25EQkFUYXNrcy5Sb2xlc1xuICAgICAgICAvLyBSZW1vdmUgcGVybWlzc2lvbnMgb24gcHVibGljIHNjaGVtYVxuICAgICAgICBjb25zdCByZW1vdmVQZXJtaXNzaW9uc09uUHVibGljU2NoZW1hUmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5leGVjdXRlKFwiUkVWT0tFIENSRUFURSBPTiBTQ0hFTUEgcHVibGljIEZST00gcHVibGljXCIpXG4gICAgICAgIGxvZ2dlci5pbmZvKGBSZXZva2UgZnJvbSBwdWJsaWMgc2NoZW1hIHN0YXRlbWVudCB0b29rICR7cmVtb3ZlUGVybWlzc2lvbnNPblB1YmxpY1NjaGVtYVJlc3VsdC50b3RhbFRpbWV9YClcblxuICAgICAgICAvLyBSZXZva2UgcGVybWlzc2lvbnMgb24gcHVibGljIHNjaGVtYSBvbiBvdXIgZGF0YWJhc2VcbiAgICAgICAgY29uc3QgcmV2b2tlT25EYXRhYmFzZVJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24uZXhlY3V0ZShgUkVWT0tFIEFMTCBPTiBEQVRBQkFTRSAke2NsdXN0ZXJTZWNyZXQuZGJuYW1lfSBGUk9NIHB1YmxpY2ApXG4gICAgICAgIGxvZ2dlci5pbmZvKGBSZXZva2UgZnJvbSBkYXRhYmFzZSB0b29rICR7cmV2b2tlT25EYXRhYmFzZVJlc3VsdC50b3RhbFRpbWV9YClcblxuICAgICAgICAvLyBDcmVhdGUgb3VyIHNjaGVtYVxuICAgICAgICBjb25zdCBzY2hlbWFDcmVhdGlvblJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24uZXhlY3V0ZShgQ1JFQVRFIFNDSEVNQSBJRiBOT1QgRVhJU1RTICR7U0NIRU1BfWApXG4gICAgICAgIGxvZ2dlci5pbmZvKGBDcmVhdGUgc2NoZW1hIHN0YXRlbWVudCB0b29rICR7c2NoZW1hQ3JlYXRpb25SZXN1bHQudG90YWxUaW1lfWApXG5cbiAgICAgICAgLy8gQ3JlYXRlIHVzZXJcbiAgICAgICAgLy8gQmFja2VuZCB1c2VyIChjYW4gZG8gYW55dGhpbmcgaW4gdGhlIHNjaGVtYSlcbiAgICAgICAgY29uc3QgREJfVVNFUiA9IGRiVXNlclNlY3JldC51c2VybmFtZVxuICAgICAgICBjb25zdCBzdG10ID0gYERPXFxcbiAgICAgICAgICAgICRkbyRcXFxuICAgICAgICAgICAgQkVHSU5cXFxuICAgICAgICAgICAgICAgIElGIEVYSVNUUyAoXFxcbiAgICAgICAgICAgICAgICAgICAgU0VMRUNUIEZST00gcGdfY2F0YWxvZy5wZ19yb2xlc1xcXG4gICAgICAgICAgICAgICAgICAgIFdIRVJFICByb2xuYW1lID0gJyR7REJfVVNFUn0nKSBUSEVOXFxcbiAgICAgICAgICAgICAgICAgICAgUkFJU0UgTk9USUNFICdSb2xlIFwiJHtEQl9VU0VSfVwiIGFscmVhZHkgZXhpc3RzLiBTa2lwcGluZyBjcmVhdGlvbi4nO1xcXG4gICAgICAgICAgICAgICAgRUxTRVxcXG4gICAgICAgICAgICAgICAgICAgIENSRUFURSBST0xFICR7REJfVVNFUn0gTE9HSU4gUEFTU1dPUkQgJyR7ZGJVc2VyU2VjcmV0LnBhc3N3b3JkfSc7XFxcbiAgICAgICAgICAgICAgICBFTkQgSUY7XFxcbiAgICAgICAgICAgICAgICBHUkFOVCBDT05ORUNUIE9OIERBVEFCQVNFICR7Y2x1c3RlclNlY3JldC5kYm5hbWV9IFRPICR7REJfVVNFUn07XFxcbiAgICAgICAgICAgICAgICBHUkFOVCBVU0FHRSBPTiBTQ0hFTUEgJHtTQ0hFTUF9IFRPICR7REJfVVNFUn07XFxcbiAgICAgICAgICAgICAgICBHUkFOVCBBTEwgUFJJVklMRUdFUyBPTiBTQ0hFTUEgJHtTQ0hFTUF9IFRPICR7REJfVVNFUn07XFxcbiAgICAgICAgICAgIEVORFxcXG4gICAgICAgICAgICAkZG8kO2BcbiAgICAgICAgY29uc3QgbWlncmF0aW9uVXNlckNyZWF0aW9uUmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5leGVjdXRlKFxuICAgICAgICAgICAgc3RtdFxuICAgICAgICApXG4gICAgICAgIGxvZ2dlci5pbmZvKGBDcmVhdGUgJHtEQl9VU0VSfSB1c2VyIHN0YXRlbWVudCB0b29rICR7bWlncmF0aW9uVXNlckNyZWF0aW9uUmVzdWx0LnRvdGFsVGltZX1gKVxuXG4gICAgICAgIGF3YWl0IGNvbm5lY3Rpb24uY2xvc2UoKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihcImVycm9yXCIsIGxvZ0RhdGEoZXJyb3IpKVxuICAgICAgICB0aHJvdyBlcnJvclxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogXCJEQlNldHVwXCIsXG4gICAgICAgIERhdGE6IHtcbiAgICAgICAgICAgIFJlc3BvbnNlOiBcIlN1Y2Nlc3NmdWxseSBzZXR1cCBEQlwiXG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc29sdmVTZWNyZXQoc2VjcmV0c01hbmFnZXI6IFNlY3JldHNNYW5hZ2VyLCBzZWNyZXRJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2VjcmV0VmFsdWUgPSBhd2FpdCBzZWNyZXRzTWFuYWdlci5nZXRTZWNyZXRWYWx1ZSh7XG4gICAgICAgIFNlY3JldElkOiBzZWNyZXRJZFxuICAgIH0pXG4gICAgaWYgKHNlY3JldFZhbHVlLlNlY3JldFN0cmluZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc2VjcmV0IHN0cmluZyBmb3IgJHtzZWNyZXRJZH1gKVxuICAgIH1cbiAgICBjb25zdCBzZWNyZXQ6IERhdGFiYXNlU2VjcmV0VmFsdWUgPSBKU09OLnBhcnNlKHNlY3JldFZhbHVlLlNlY3JldFN0cmluZylcbiAgICByZXR1cm4gc2VjcmV0XG59XG5cbmZ1bmN0aW9uIGdldENvbm5lY3Rpb24oc2VjcmV0OiBEYXRhYmFzZVNlY3JldFZhbHVlKTogQ29ubmVjdGlvbiB7XG4gICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uKHtcbiAgICAgICAgaG9zdDogc2VjcmV0Lmhvc3QsXG4gICAgICAgIHBvcnQ6IHNlY3JldC5wb3J0LFxuICAgICAgICB1c2VyOiBzZWNyZXQudXNlcm5hbWUsXG4gICAgICAgIHBhc3N3b3JkOiBzZWNyZXQucGFzc3dvcmQsXG4gICAgICAgIGRhdGFiYXNlOiBzZWNyZXQuZGJuYW1lLFxuICAgICAgICBzc2w6IHtcbiAgICAgICAgICAgIHJlamVjdFVuYXV0aG9yaXplZDogZmFsc2UsXG4gICAgICAgICAgICBjYTogcmVhZEZpbGVTeW5jKFwiLi9ldS13ZXN0LTEtYnVuZGxlLmNlcnRcIikudG9TdHJpbmcoKSAvLyBjZXJ0IGZyb20gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FtYXpvblJEUy9sYXRlc3QvQXVyb3JhVXNlckd1aWRlL1VzaW5nV2l0aFJEUy5TU0wuaHRtbFxuICAgICAgICB9XG4gICAgfSlcbn1cbiJdfQ==